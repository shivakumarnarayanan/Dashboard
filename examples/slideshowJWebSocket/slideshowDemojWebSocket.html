<!DOCTYPE html>
<html>
<head>

    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link rel="shortcut icon" href="../../../resources/images/favicon.ico" />
    <link rel="stylesheet" href="../../../resources/css/demo.css" />
    <title>Slideshow jWebSocket Demo</title>

		<!-- load the jWebSocket JavaScript client library -->
		<script src="../../res/js/jWebSocket.js" type="text/javascript"></script>

		<script>
	    
		var slide ;
		var lastMessageSentUniqueId;
		var currentSlideNumber;
		var lWSC = null;

        function setup() {
            slide = document.getElementById("slide");           
        }

		function scrollLogToBottom() {
			if( eLog.scrollHeight > eLog.clientHeight ) {
				eLog.scrollTop = eLog.scrollHeight - eLog.clientHeight;
			}
		}

		function log( aString ) {
			eLog.innerHTML += aString + "<br>";
			scrollLogToBottom();
		}

		function clearLog() {
			eLog.innerHTML = "";
			eLog.scrollTop = 0;
		}


		function connect() {
			var lURL = jws.getDefaultServerURL();

			log( "Connecting to " + lURL + " ..." );
			var lRes = lWSC.open( lURL
			                    , {

									// OnOpen callback
									OnOpen: function( aEvent ) {
												log( "<font style='color:#888'>jWebSocket connection established.</font>" );
												jws.$("simgStatus").src = "../../images/connected.png";
											},
		
									// OnWelcome callback
									OnWelcome: function( aEvent ) {						
									},

									// OnMessage callback
									OnMessage: function( aEvent ) {
												log( "<font style='color:#888'>jWebSocket message received: '" + aEvent.data + "'</font>" );
												jws.$("simgStatus").src = "../../images/authenticated.png";

												jws.$("slblClientId").innerHTML = "&nbsp;Client&#x2011;Id:&nbsp;"
													+ lWSC.getId() + "&nbsp;"
													+ ( jws.browserSupportsNativeWebSockets ? "(native)" : "(flashbridge)" );
												},

									// OnToken callback
									OnToken: function( aToken ) {
												// check if slide has to be updated
												if( aToken.action == "slide") {
													log("new slide selected: slide number  "+ aToken.slideNumber );
													if (lastMessageSentUniqueId != aToken.uniqueId) {
														adjustSlide( aToken.slideNumber);
													}
												}
									},

									// OnClose callback
									OnClose: function( aEvent ) {
										log( "<font style='color:#888'>jWebSocket connection closed.</font>" );
										jws.$("simgStatus").src = "../../images/disconnected.png";
										jws.$("slblClientId").innerHTML = "&nbsp;Client&#x2011;Id:&nbsp;-";
									}
								}
								);

			log( lWSC.resultToString( lRes ) );
			
			}

				
	function setSlide( slideNumber) {
	  adjustSlide(slideNumber);
	  uniqueId  = uniqid();
	  lastMessageSentUniqueId = uniqueId;
	  lWSC.broadcastToken({
						    action: "slide",
						    uniqueId: uniqueId,
						    slideNumber: slideNumber,
						    senderIncluded: true,
						    responseRequested: false,
  						  }
						);
	}

	var defaultColor='black';
	var highlightColor = 'blue';
	
	function adjustSlide( slideNumber) {
	  markSlideLink (currentSlideNumber, defaultColor);
      currentSlideNumber = slideNumber;	
	  slide.src = "images/nature"+slideNumber+".jpg"; 
	  markSlideLink (currentSlideNumber, highlightColor);
	}

    function markSlideLink (slideNumber, color) {
	  var slideLink = document.getElementById("slide"+slideNumber);
	  if (slideLink) {
	    var span = slideLink.childNodes[0];
	    span.style.color =color;
      }
	}
    
	function uniqid()
        {
        var newDate = new Date;
        return newDate.getTime();
        }
      
	function initPage() {
		eLog = jws.$( "sdivLog" );
        setup();
		if( jws.browserSupportsWebSockets() ) {
			lWSC = new jws.jWebSocketJSONClient();
            alert("Shiva");
		} else {
			var lMsg = jws.MSG_WS_NOT_SUPPORTED;
			alert( lMsg );
			log( lMsg );
		}
		connect();
	}

	function disconnect() {
		if( lWSC ) {
			log( "Disconnecting..." );
			var lRes = lWSC.close({ timeout: 3000 });
			log( lWSC.resultToString( lRes ) );
		}
	}

	function exitPage() {
		disconnect();
	}

		
    </script>
</head>
<body 	onload="initPage();"
		onunload="exitPage();"
        style="background-color:transparent">
    <h4>Slideshow over WebSocket and jWebSocket Server Demo</h4>
    <span class="info" style="width:600px">This demo uses the WebSocket API to send
        JSON messages (representing image selections) to the jWebSocket service, which broadcasts the messages to listeners - in general, not subscribed to any particular channel.</span>
		<table class="tblHeader" width="100%" cellspacing="0" cellpadding="0">
			<tr>
				<td class="tdHeader" width="1%"><img id="simgStatus" src="../../images/disconnected.png" align="right"/></td>
				<td class="tdHeader" width="1%"><span id="slblClientId">&nbsp;Client&#x2011;Id:&nbsp;-</span></td>
			</tr>
		</table>

		<div>
        <img id="slide" src="images/nature1.jpg" />
		<ul>
		  <li><a id="slide1" onclick="setSlide(1);"><span>Slide One</span></a></li>
		  <li><a id="slide2" onclick="setSlide(2);"><span>Slide Two</a></span></li>
		  <li><a id="slide3" onclick="setSlide(3);"><span>Slide Three</a></span></li>
		  <li><a id="slide4" onclick="setSlide(4);"><span>Slide Four</a></span></li>
		  <li><a id="slide5" onclick="setSlide(5);"><span>Slide Five</span></a></li>
		</ul>
	</div>
		<div id="sdivLog" class="sdivContainer" style=""
			 style="position:relative; height:100px; overflow:auto;">
		</div>
</body>
</html>
